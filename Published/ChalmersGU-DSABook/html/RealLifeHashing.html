
<!DOCTYPE html>




<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>9.11. Hash Tables in Real Life (optional) &mdash; Data Structures and Algorithms</title>
    
    <link rel="stylesheet" href="_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../lib/normalize.css" type="text/css" />
    <link rel="stylesheet" href="../../../lib/JSAV.css" type="text/css" />
    <link rel="stylesheet" href="../../../lib/odsaMOD-min.css" type="text/css" />
    <link rel="stylesheet" href="../../../lib/jquery.ui.min.css" type="text/css" />
    <link rel="stylesheet" href="../../../lib/odsaStyle-min.css" type="text/css" />
    <link rel="stylesheet" href="../../../lib/accessibility.css" type="text/css" />
    
  <script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
      URL_ROOT:    './',
      VERSION:     '0.4.1',
      COLLAPSE_INDEX: false,
      FILE_SUFFIX: '.html',
      HAS_SOURCE:  true
    };
  </script>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
        processEscapes: true
      },
      "HTML-CSS": {
        scale: "80"
      }
    });
  </script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="index" title="Data Structures and Algorithms" href="index.html" />
    <link rel="next" title="12. Hashing Chapter Summary Exercises" href="HashSumm.html" />
    <link rel="prev" title="10. Open Addressing, Deletion" href="HashDel.html" />

  </head>

  <body>


      <div class="header">
        
  
      <script type="text/javascript" src="../../../lib/jquery.min.js"></script>
      <script type="text/javascript" src="../../../lib/jquery.migrate.min.js"></script>
      <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/localforage/1.9.0/localforage.min.js"></script>
      <script type="text/javascript" src="../../../lib/accessibility.js"></script>
    <script type="text/javascript" src="../../../lib/jquery.ui.min.js"></script>
    <script type="text/javascript" src="../../../lib/jquery.transit.js"></script>
    <script type="text/javascript" src="../../../lib/raphael.js"></script>
    <script type="text/javascript" src="../../../lib/JSAV-min.js"></script>
    <script type="text/javascript" src="_static/config.js"></script>
    <script type="text/javascript" src="../../../lib/timeme-min.js"></script>
    <script type="text/javascript" src="../../../lib/odsaUtils-min.js"></script>
    <script type="text/javascript" src="../../../lib/odsaMOD-min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.min.js"></script>
    <script type="text/javascript" src="https://d3js.org/d3-selection-multi.v1.min.js"></script>
    <script type="text/javascript" src="../../../lib/dataStructures.js"></script>
    <script type="text/javascript" src="../../../lib/conceptMap.js"></script>

        
<a id="username-link" style="float:right;color:red;margin:10px 20px auto; display: none" class="username-link" href="Gradebook.html"></a>
<a id="login-link" style="float:right;color:red;margin:10px 20px auto" class="login-link" href="#"><Macro 'login'></a>
<div id="login-box" class="login-popup">
  <a href="#" class="close"><img src="_static/Images/close_pop.png" class="btn_close" title="Close Window" alt="Close" /></a>
  <form method="post" class="signin" action="https://#">
    <fieldset class="textbox">
      <label class="username">
        <span>Username</span>
        <input id="username" value="" type="text" autocomplete="on" placeholder="Username" tabindex="1">
      </label>
      <label class="password">
        <span>Password</span>
        <input id="password" value="" type="password" placeholder="Password" tabindex="2">
        <span><a id="forgot" href="#">Forgot your password?</a></span>
      </label>

      <p>
        <input type="submit" id="login-submit-button" value="Sign in" tabindex="3" />
      </p>
      <p>
        <input type="button" id="register-button" value="Register" tabindex="4" />
      </p>
    </fieldset>
  </form>
</div>

        
<a id="registration-link" style="float:right;color:red;margin:10px 20px auto" class="registration-link" href="#">Register</a>
<div id="registration-box" class="registration-popup ">
  <a href="#" class="close"><img src="_static/Images/close_pop.png" class="btn_close" title="Close Window" alt="Close Window" /></a>
  <form method="post" class="signin" action="https://#">
    <fieldset class="textbox">
      <div id="register_error" class="error"></div>
      <label class="username">
        <span>Username:</span>
        <input type="text" id="user" placeholder="Username" />
      </label>

      <label class="password">
        <span>Password</span>
        <input id="pass" type="password" placeholder="Password" />
      </label>

      <label class="password">
        <span>Confirm Password</span>
        <input id="rpass" type="password" placeholder="Confirm Password" />
      </label>

      <label class="email">
        <span>Email:</span>
        <input type="text" id="email" placeholder="Email">
      </label>

      <p>
        <input type="submit" id="register-submit-button" value="Register &rarr;"/>
      </p>
    </fieldset>
  </form>
</div>
<img class="leftlogo" src="_static/OpenDSALogoT64.png" alt="Logo"/><div class="title-wrapper">
          <div class="title-inbetween" style="display: table-cell; vertical-align: middle;">
            <div class="title-content">
              <h1 class="heading" ><a href="index.html">
                <span>Data Structures and Algorithms</span></a></h1>
              <h2 class="heading" ><span>Chapter 9 Hash Tables</span></h2>
            </div>
          </div>
        </div>
      </div>
      <div class="topnav">
        <p>
            <a style="float:left;color:blue;" href="../source/RealLifeHashing.rst.rst"
              target="_blank" rel="nofollow">Show Source | </a>&#160;&#160;
            <a class="abt" style="float:left;color:blue;" href="#" rel="nofollow">| About</a>&#160;&#160;

          
        «&#160;&#160;<a id="prevmod" href="HashDel.html">9.<span class="section-number">10. </span>Open Addressing, Deletion</a>
        &#160;&#160;::&#160;&#160;
        <a  class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a  id="nextmod" href="HashSumm.html">9.<span class="section-number">12. </span>Hashing Chapter Summary Exercises</a>&#160;&#160;»


        </p>
      </div>
       
      <div class="content">
        
  <script>ODSA.SETTINGS.MODULE_SECTIONS = ['algorithmic-complexity-attacks', 'breaking-hash-functions', 'how-java-s-hash-tables-are-implemented', 'hash-functions-and-hash-tables-in-python'];</script><script>ODSA.SETTINGS.DISP_MOD_COMP = true;ODSA.SETTINGS.MODULE_NAME = "RealLifeHashing";ODSA.SETTINGS.MODULE_LONG_NAME = "Hash Tables in Real Life (optional)";ODSA.SETTINGS.MODULE_CHAPTER = "Hash Tables"; ODSA.SETTINGS.BUILD_DATE = "2022-01-24 00:21:12"; ODSA.SETTINGS.BUILD_CMAP = true;JSAV_OPTIONS['lang']='en';JSAV_EXERCISE_OPTIONS['code']='pseudo';</script><div class="section" id="hash-tables-in-real-life-optional">
<h1>9.<span class="section-number">11. </span>Hash Tables in Real Life (optional)<a class="headerlink" href="#hash-tables-in-real-life-optional" title="Permalink to this headline">¶</a></h1>
<p>Here we will give some examples of problems with hashing,
and how Java and Python implement hashing and hash tables internally.</p>
<div class="section" id="algorithmic-complexity-attacks">
<h2>9.<span class="section-number">11.1. </span>Algorithmic complexity attacks<a class="headerlink" href="#algorithmic-complexity-attacks" title="Permalink to this headline">¶</a></h2>
<p>As we wrote in the chapter introduction:</p>
<p>“When properly implemented, these operations can be performed in constant time.
(…)
However, even though hashing is based on a very simple idea,
it is surprisingly difficult to implement properly.”</p>
<p>This difficulty can be (and has been) exploited for malicious attacks on systems, so called algorithmic complexity attacks.
We’ll leave the word to Adam Jacobson and David Renardy to give an introduction to the problems
(please read the whole text, it’s an easy read):</p>
<p>“An Algorithmic Complexity (AC) attack is a resource exhaustion attack that takes advantage of worst-case performance in server-side algorithms.”
(<a class="reference external" href="https://twosixtech.com/algorithmic-complexity-vulnerabilities-an-introduction">https://twosixtech.com/algorithmic-complexity-vulnerabilities-an-introduction</a>)</p>
<p>As you can see, hash tables even have a category of itself (“Hashtable DoS Attacks”).
They only mention separate chaining (“These hash tables utilized a linked list”),
but the same problem arises for open addressing.
(In fact, Python hash tables are open addressing – see below).</p>
<p>The problem is that it is extremely difficult to write good hash functions.</p>
</div>
<div class="section" id="breaking-hash-functions">
<h2>9.<span class="section-number">11.2. </span>Breaking hash functions<a class="headerlink" href="#breaking-hash-functions" title="Permalink to this headline">¶</a></h2>
<p>Java’s default algorithm for calculating a hash code from a string <span class="math notranslate nohighlight">\(s\)</span> looks like this:
<span class="math notranslate nohighlight">\(s_0\cdot 31^{n-1} + s_1\cdot 31^{n-2} + ... + s_{n-2}\cdot 31^1 + s_{n-1}\cdot 31^0\)</span>.
(Source: <a class="reference external" href="https://github.com/openjdk/jdk/blob/9f75d5ce500886b32175cc541939b7f0eee190ca/src/java.base/share/classes/java/lang/StringUTF16.java#L414-L420">hashCode() in StringUTF16.java</a>).</p>
<p>This works well in practice, <em>if you assume that your data is normal</em>!
But an attacker does not use normal data – instead they deliberately create data that will
break the system. For example, suppose the attacker knows that you store user data in a Java HashMap
with the username as key. Then they can create lots of artifical usernames to put in the database
to make searching in the database slow. That’s a hashtable DoS attack!</p>
<p>It’s really easy to break Java’s string hash function if you want to. It relies on the fact that
the following two strings have the same hashcode:</p>
<div class="highlight-guess notranslate"><div class="highlight"><pre><span></span>&quot;Aa&quot;.hashCode() == &quot;BB&quot;.hashCode() == 2112
</pre></div>
</div>
<p>Therefore, all same-length repetitions of “Aa” and “BB” have the same hash code:</p>
<div class="highlight-guess notranslate"><div class="highlight"><pre><span></span>&quot;AaAaAaAaAa&quot;, &quot;AaAaAaAaBB&quot;, &quot;AaAaAaBBAa&quot;, &quot;AaAaAaBBBB&quot;, ...,
&quot;BBBBBBAaAa&quot;, &quot;BBBBBBAaBB&quot;, &quot;BBBBBBBBAa&quot;, &quot;BBBBBBBBBB&quot;
</pre></div>
</div>
<p>There are <span class="math notranslate nohighlight">\(2^k\)</span> possible strings with <span class="math notranslate nohighlight">\(k\)</span> repetitions of “Aa” resp. “BB”,
and all these strings have the same hash code!
An attacker could insert all these strings into a Java HashMap and then all of them
would be in the same bucket and we would resort to linear search through a linked list
of <span class="math notranslate nohighlight">\(2^k\)</span> strings.</p>
<p>Here’s a short article explaining this:
<a class="reference external" href="https://dzone.com/articles/what-is-wrong-with-hashcode-in-javalangstring">https://dzone.com/articles/what-is-wrong-with-hashcode-in-javalangstring</a></p>
<p>Note that this would not be improved by using an open addressing hash table, because then
we would get a primary cluster with <span class="math notranslate nohighlight">\(2^k\)</span> strings.</p>
</div>
<div class="section" id="how-java-s-hash-tables-are-implemented">
<h2>9.<span class="section-number">11.3. </span>How Java’s hash tables are implemented<a class="headerlink" href="#how-java-s-hash-tables-are-implemented" title="Permalink to this headline">¶</a></h2>
<p>Before version 1.2, Java had exactly the problem above, but in version 1.2 they changed the implementation.
The current version of Java HashMap (and HashSet and Hashtable and similar) has the following characteristics:</p>
<ul class="simple">
<li><p>It’s a separate chaining hash table.</p></li>
<li><p>Small buckets (&lt;8 elements) are linked lists, but larger buckets are red-black trees instead.
This ensures <span class="math notranslate nohighlight">\(O(n \log n)\)</span> worst time complexity, but it’s linear if the data is well-behaved.</p></li>
<li><p>The size of the hash table is a power of two (<span class="math notranslate nohighlight">\(n=2^k\)</span>) – meaning that the resizing factor is 2.</p></li>
<li><p>The maximum load factor for resizing is 0.75.</p></li>
</ul>
<p>If you’re interested you can read the comment on <a class="reference external" href="https://github.com/openjdk/jdk/blob/9e831bccd2fc90681b32d1504eca753462afc6f6/src/java.base/share/classes/java/util/HashMap.java#L145-L233">lines 125–232 in HashMap.java</a>,
where some implementation details are explained.</p>
</div>
<div class="section" id="hash-functions-and-hash-tables-in-python">
<h2>9.<span class="section-number">11.4. </span>Hash functions and hash tables in Python<a class="headerlink" href="#hash-functions-and-hash-tables-in-python" title="Permalink to this headline">¶</a></h2>
<p>Python uses much more modern implementations than Java, of both hash functions and hash tables.
Python hash functions uses a combination of the following techniques:</p>
<ul class="simple">
<li><p>Strings are hashed using <a class="reference external" href="https://en.wikipedia.org/wiki/SipHash">SipHash</a>
(see <a class="reference external" href="https://www.python.org/dev/peps/pep-0456">PEP-456</a>).</p></li>
<li><p>Tuples are hashed using “a slightly simplified version of the <a class="reference external" href="http://cyan4973.github.io/xxHash/">xxHash non-cryptographic hash</a>”
(see <a class="reference external" href="https://github.com/python/cpython/blob/8f24b7dbcbd83311dad510863d8cb41f0e91b464/Objects/tupleobject.c#L384-L397">lines 384–397 in tupleobject.c</a>).</p></li>
<li><p>In addition, Python adds randomisation: Whenever you start a new Python interpreter,
it creates a random constant which is combined with the hashes.
This means that every new instance will generate new hashes for the same strings, tuples, and other built-in objeccts.</p></li>
</ul>
<p>Python dictionaries are implemented as hash tables. Since version 3.6 they are based on the following ideas (lecture video from PyCon 2017):</p>
<ul class="simple">
<li><p>Raymond Hettinger: Modern Python Dictionaries – A confluence of a dozen great ideas, PyCon 2017:
<a class="reference external" href="https://www.youtube.com/watch?v=npw4s1QTmPg">https://www.youtube.com/watch?v=npw4s1QTmPg</a>
(the part about sharing several values in one table is only used for internal use in the Python interpreter)</p></li>
<li><p>And a blog post explaining the new implementation:
<a class="reference external" href="https://morepypy.blogspot.com/2015/01/faster-more-memory-efficient-and-more.html">https://morepypy.blogspot.com/2015/01/faster-more-memory-efficient-and-more.html</a>
(it was first implemented in PyPy, but then they ported it to “standard” CPython too)</p></li>
</ul>
<p>Here’s a summary of the internal implementation:</p>
<ul class="simple">
<li><p>All hash tables have a power-of-two size (<span class="math notranslate nohighlight">\(n=2^k\)</span>) – meaning that the resizing factor is 2.</p></li>
<li><p>This means that the table index is the first (least significant) <span class="math notranslate nohighlight">\(k\)</span> bits of the hash value.</p></li>
<li><p>It’s an open adressing hash table.</p></li>
<li><p>But it doesn’t use linear probing, instead they probe with <span class="math notranslate nohighlight">\(+p\)</span> in every step,
where <span class="math notranslate nohighlight">\(p\)</span> depends on the higher bits in the hash value.</p></li>
<li><p>It keeps the full hash value in the table (which improves the speed when resizing)</p></li>
<li><p>To get better memory efficiency, it is split into (1) a size <span class="math notranslate nohighlight">\(2^k\)</span> integer array with indices,
and (2) a compact array with tuples of the form (hash,key,value).
The indices in array(1) point to locations in array(2).</p></li>
<li><p>This also has the effect that it can iterate over the insertion order of the elements.</p></li>
<li><p>Deletion is done using tombstones.</p></li>
<li><p>The maximum load factor for resizing is 0.66.</p></li>
<li><p>See the source code here: <a class="reference external" href="https://github.com/python/cpython/blob/main/Objects/dictobject.c">https://github.com/python/cpython/blob/main/Objects/dictobject.c</a></p></li>
</ul>
</div>
</div>


      </div>
      <div class="bottomnav">
      <p><span class="email_div" style="display:inline;"><a id="contact_us" class="contact" style="float:left;color:blue;" rel="nofollow" href="mailto:">Contact Us |</a><a style="float:left;color:blue;" rel="nofollow" href="../../../lib/Privacy.html" target="_blank">| Privacy |</a> <a style="float:left;color:blue;" rel="nofollow" href="../../../lib/license.html" target="_blank">| License</a></span>&#160;&#160;
      
        «&#160;&#160;<a id="prevmod1" href="HashDel.html">9.<span class="section-number">10. </span>Open Addressing, Deletion</a>
        &#160;&#160;::&#160;&#160;
        <a  class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a  id="nextmod1" href="HashSumm.html">9.<span class="section-number">12. </span>Hashing Chapter Summary Exercises</a>&#160;&#160;»

</p>
      </div>
      <img style="float:right;" src="_static/nsf1.gif" height="62" width="62" alt="nsf"/>


    <div class="footer">
      <p>
        <span class="email_div" style="display:inline;">
          <a id="contact_us" class="contact" style="float:left;color:blue;" rel="nofollow" href="mailto:">Contact Us |</a>
          <a id="bugreport-link" style="float:left;color:blue;" class="bugreport-link" href="#">| Report a bug</a>
        </span>
      </p>
        &copy; Copyright 2016 by OpenDSA Project Contributors and distributed under an MIT license.
      Last updated on Jan 24, 2022.
      Created using <a target="_blank" href="http://sphinx.pocoo.org/">Sphinx</a> 2.4.4.
    </div>
    
<div id="bugreport-box" class="bugreport-popup ">
  <a href="#" class="close"><img src="_static/Images/close_pop.png" class="btn_close" title="Close Window" alt="Close Window" /></a>
  <form method="post" class="report" action="https://#">
    <fieldset class="textbox">
      <div id="bug_error" class="error"></div>
      <label>
        <span>Summary*:</span>
        <input type="text" id="b_title" placeholder="Summary" />
      </label>

      <label class="os">
        <span>Operating system*:</span>
        <select id="b_os">
          <option value="windows">Windows</option>
          <option value="macos">Mac OS</option>
          <option value="linux">Linux</option>
          <option value="ios">iOS</option>
          <option value="android">Android</option>
          <option value="other">Other</option>
        </select>
      </label>

      <label class="browser">
        <span>Browser*:</span>
        <select id="b_browser">
          <option value="chrome">Chrome</option>
          <option value="safari">Safari</option>
          <option value="internetexplorer">Internet Explorer</option>
          <option value="opera">Opera</option>
          <option value="other">Other</option>
        </select>
      </label>

      <label class="description">
        <span>Description*:</span><br>
        <textarea id="b_description" rows="5" cols="25" placeholder="***BUG** Please enter: (1) a consice description of the problem. (2) steps to reproduce bug. (3) the version of your browser and operating system."></textarea>
      </label>

      <label class="screenshot">
        <span>Attach a screenshot (optional):</span>
        <input type="file" id="b_screenshot" accept="image/*" placeholder="Attach a screenshot (optional)">
      </label>

      <p>
        <input type="submit" id="bug-submit-button" value="Submit &rarr;"/>
      </p>
    </fieldset>
  </form>
</div>

  </body>
</html>